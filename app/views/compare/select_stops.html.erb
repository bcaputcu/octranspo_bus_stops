<div class="page-header">
	<h1>Select Stops and Routes</h1>
	<h3>
		<small><span class="label label-info">Tip</span>
			Right click on markers to select stops
		</small>
	</h3>
</div>

<% if user_signed_in? %>
<ul class="nav nav-tabs">
	<li class="active"><a href="#mapTab" data-toggle="tab">Map</a></li>
	<li><a href="#favoritesTab" data-toggle="tab">Favorites</a></li>
</ul>

<div class="tab-content">
	<div class="tab-pane active" id="mapTab">
		<%= gmaps(map_options: {zoom: 16, detect_location: true, center_on_user: true, auto_adjust: false}, markers: { data: @json, options: { do_clustering: true, clusterer_maxZoom: 13 } }) %>
	</div>
	<div class="tab-pane" id="favoritesTab">
		<div style="height:414px;">
			Soon!
		</div>
	</div>
</div>
<% else %>
<%= gmaps(map_options: {zoom: 16, detect_location: true, center_on_user: true, auto_adjust: false}, markers: { data: @json, options: { do_clustering: true, clusterer_maxZoom: 13 } }) %>
<% end %>

<%= form_tag '/compare/result', :method => :get, id: 'stops_form' do %>

<h3>Selected Stops <%= image_tag("loading.gif", class: "hidden", id: "loading_indicator") %></h3>
<table class="table table-bordered" id="selected_stops_table">
	<thead>
		<tr>
			<th>#</th>
			<th>Code</th>
			<th>Name</th>
			<th>Route</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<%= button_tag 'Reset', class: "btn btn-warning", id: "stops_form_reset", type: "reset" %>
<%= button_tag 'Next', class: "btn btn-success disabled", id: "stops_form_submit", disabled: true %>

<% end %>

<%= content_for :scripts do %>
<script type="text/javascript" charset="utf-8">
$(function() {

	var selected_stops = [];

	$("#stops_form_reset").click(function(){
		selected_stops = [];

		$('#selected_stops_table tbody').empty();

		$('#stops_form_submit').addClass("disabled");
		$('#stops_form_submit').addAttr("disabled");
	});

	$("#stops_form_submit").click(function(){

		$("#stops_form").submit();
		
	});

	Gmaps.map.callback = function() {

		for (var i = 0; i <  Gmaps.map.markers.length; ++i) {
			var marker = Gmaps.map.markers[i].serviceObject
			marker.marker_id = Gmaps.map.markers[i].id;
			marker.marker_name = Gmaps.map.markers[i].name;
			google.maps.event.addListener(marker, 'rightclick', function() {

				if (selected_stops.length >= 10) {
					alert("Cannot add more than 10 stops.");
				} else {
					var answer = confirm("Do you want to select stop: " + this.marker_name + "?");

					if (answer) {
						selected_stops.push(this.marker_id);
						getStop(this.marker_id, selected_stops.length);

						$('#stops_form_submit').removeClass("disabled");
						$('#stops_form_submit').removeAttr("disabled");
					}
				}

			});
		}
	};

	function getStop(stop_id, stop_index) {
		$.ajax({
			url: "/stops/" + stop_id + ".json",
			beforeSend: function () {
				$('#loading_indicator').removeClass("hidden");
			},
			success: function (data) {
				var tableRowHTML = "<tr><td>Stop " + stop_index + "</td><td>" + data.code + "</td><td>" + data.name + "</td><td><select id='routes_" + stop_id + "' name='routes[" + stop_id + "]'></select></td></tr>";

				$('#selected_stops_table > tbody:last').append(tableRowHTML);

				$.each(data.routes, function(key, value) {   
					$("#routes_" + stop_id)
					.append($("<option></option>")
						.attr("value",value.id)
						.text(value.no + " - " + value.direction)); 
				});
			},
			complete: function () {
				$('#loading_indicator').addClass("hidden");
			}
		});
	}

});

</script>
<% end %>